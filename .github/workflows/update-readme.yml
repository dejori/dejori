name: Update README Stats

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get coding language stats
        id: github
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Get all repos for user
          REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/user/repos?per_page=100&type=owner")

          # Aggregate language bytes across all repos
          declare -A LANG_BYTES
          TOTAL_BYTES=0

          for repo in $(echo "$REPOS" | jq -r '.[].full_name'); do
            LANGS=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$repo/languages")

            for lang in $(echo "$LANGS" | jq -r 'keys[]'); do
              bytes=$(echo "$LANGS" | jq -r ".[\"$lang\"]")
              LANG_BYTES[$lang]=$((${LANG_BYTES[$lang]:-0} + bytes))
              TOTAL_BYTES=$((TOTAL_BYTES + bytes))
            done
          done

          # Sort languages by bytes and get top 3
          SORTED=$(for lang in "${!LANG_BYTES[@]}"; do
            echo "${LANG_BYTES[$lang]} $lang"
          done | sort -rn | head -3)

          # Calculate percentages and build bar chart
          BAR_WIDTH=20
          BAR=""
          LEGEND=""
          CHARS=("█" "░" "▒")
          i=0
          TOP3_BYTES=0

          while read -r bytes lang; do
            if [ -n "$bytes" ] && [ "$TOTAL_BYTES" -gt 0 ]; then
              TOP3_BYTES=$((TOP3_BYTES + bytes))
              pct=$((bytes * 100 / TOTAL_BYTES))
              chars=$((pct * BAR_WIDTH / 100))
              [ $chars -eq 0 ] && [ $pct -gt 0 ] && chars=1

              for ((j=0; j<chars; j++)); do
                BAR="${BAR}${CHARS[$i]}"
              done

              if [ -n "$LEGEND" ]; then
                LEGEND="${LEGEND} | "
              fi
              LEGEND="${LEGEND}${lang} ${pct}%"
              i=$((i + 1))
            fi
          done <<< "$SORTED"

          # Calculate and add "Other" if there's remaining percentage
          OTHER_BYTES=$((TOTAL_BYTES - TOP3_BYTES))
          if [ "$OTHER_BYTES" -gt 0 ] && [ "$TOTAL_BYTES" -gt 0 ]; then
            OTHER_PCT=$((OTHER_BYTES * 100 / TOTAL_BYTES))
            if [ "$OTHER_PCT" -gt 0 ]; then
              chars=$((OTHER_PCT * BAR_WIDTH / 100))
              [ $chars -eq 0 ] && chars=1
              for ((j=0; j<chars; j++)); do
                BAR="${BAR}·"
              done
              LEGEND="${LEGEND} | Other ${OTHER_PCT}%"
            fi
          fi

          # Fill remaining bar space if needed
          current_len=${#BAR}
          while [ $current_len -lt $BAR_WIDTH ]; do
            BAR="${BAR} "
            current_len=$((current_len + 1))
          done

          STATS="${BAR} ${LEGEND}"
          echo "language_stats=$STATS" >> $GITHUB_OUTPUT

      - name: Get latest Mendeley paper
        id: mendeley
        env:
          MENDELEY_CLIENT_ID: ${{ secrets.MENDELEY_CLIENT_ID }}
          MENDELEY_CLIENT_SECRET: ${{ secrets.MENDELEY_CLIENT_SECRET }}
          MENDELEY_REFRESH_TOKEN: ${{ secrets.MENDELEY_REFRESH_TOKEN }}
        run: |
          # Get access token using refresh token
          TOKEN_RESPONSE=$(curl -s -X POST https://api.mendeley.com/oauth/token \
            -d "grant_type=refresh_token" \
            -d "refresh_token=$MENDELEY_REFRESH_TOKEN" \
            -d "client_id=$MENDELEY_CLIENT_ID" \
            -d "client_secret=$MENDELEY_CLIENT_SECRET")

          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')

          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get access token"
            echo "paper_text=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get most recently added document
          PAPER=$(curl -s "https://api.mendeley.com/documents?sort=created&order=desc&limit=1" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Accept: application/vnd.mendeley-document.1+json")

          TITLE=$(echo $PAPER | jq -r '.[0].title')
          AUTHORS=$(echo $PAPER | jq -r '.[0].authors | map(.last_name) | join(", ")')
          YEAR=$(echo $PAPER | jq -r '.[0].year // empty')
          URL=$(echo $PAPER | jq -r '.[0].websites[0] // empty')
          DOI=$(echo $PAPER | jq -r '.[0].identifiers.doi // empty')
          ARXIV=$(echo $PAPER | jq -r '.[0].identifiers.arxiv // empty')

          # Pick best URL: website > DOI > arXiv
          if [ -z "$URL" ] || [ "$URL" == "null" ]; then
            if [ -n "$DOI" ] && [ "$DOI" != "null" ]; then
              URL="https://doi.org/$DOI"
            elif [ -n "$ARXIV" ] && [ "$ARXIV" != "null" ]; then
              URL="https://arxiv.org/abs/$ARXIV"
            fi
          fi

          if [ "$TITLE" != "null" ] && [ -n "$TITLE" ]; then
            if [ -n "$YEAR" ] && [ "$YEAR" != "null" ]; then
              PAPER_TEXT="*${TITLE}* by ${AUTHORS} (${YEAR})"
            else
              PAPER_TEXT="*${TITLE}* by ${AUTHORS}"
            fi

            # Add link at end if available
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              PAPER_TEXT="${PAPER_TEXT} [[ref]](${URL})"
            fi

            echo "paper_text=$PAPER_TEXT" >> $GITHUB_OUTPUT
          else
            echo "paper_text=" >> $GITHUB_OUTPUT
          fi

      - name: Update README
        run: |
          STATS="${{ steps.github.outputs.language_stats }}"
          PAPER="${{ steps.mendeley.outputs.paper_text }}"

          # Update language stats (use # as delimiter to avoid | conflicts)
          if [ -n "$STATS" ]; then
            sed -i "s#<!-- LANG:START -->.*<!-- LANG:END -->#<!-- LANG:START -->${STATS}<!-- LANG:END -->#" README.md
          fi

          # Update paper
          if [ -n "$PAPER" ]; then
            sed -i "s#<!-- PAPER:START -->.*<!-- PAPER:END -->#<!-- PAPER:START -->${PAPER}<!-- PAPER:END -->#" README.md
          fi

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git diff --quiet README.md || (git add README.md && git commit -m "Update README stats")
          git push
